import uuid
from datetime import datetime, timezone
from fastapi import APIRouter
from app.core.database import db
from app.core.security import hash_password

router = APIRouter(tags=["seed"])


@router.post("/update-master-prompt")
async def update_master_prompt():
    """Update master prompt to improved version"""
    now = datetime.now(timezone.utc).isoformat()
    
    new_content = """Я буду представлять тебе тексты транскриптов встреч.

ИСПРАВЛЕНИЕ ОШИБОК:
Местами в них будут ошибки распознавания. Если заметишь такие ошибки (слова не соответствующие теме и контексту, искажённые имена, термины, аббревиатуры) — исправь их по контексту.
Суммаризировать высказывания спикеров нельзя, твоя задача — сохранять дословные транскрипты.

ОБЪЕДИНЕНИЕ РЕПЛИК:
В текстах транскрипта будут встречаться предложения, в середине которых происходит смена спикера (например — реплика следующего спикера начинается с маленькой буквы). В этом случае перенеси остальную часть фразы (до точки) в реплику предыдущего спикера.
Пример:
Speaker 1: ...Ты расскажи, ты общался там с кем-нибудь вообще? Слушай,
Speaker 2: если честно, пока ещё нет.

Надо делать так:
Speaker 1: ...Ты расскажи, ты общался там с кем-нибудь вообще?
Speaker 2: Слушай, если честно, пока ещё нет.

ЗАМЕНА СПИКЕРОВ:
Тебе также нужно будет делать замены авторов реплик в тексте — я буду их указывать перед началом текста транскрипта, например:
Speaker 0 — Дмитрий
Speaker 1 — Сабина

ФОРМАТИРОВАНИЕ:
- Сделай выделение имен спикеров болдом
- Отделяй реплики спикеров друг от друга пробелами
- Внутри реплики спикера пробелов между строчками не делай
- Разбивай длинные куски текста на смысловые абзацы для удобства чтения, но не отделяй эти абзацы внутри реплик спикеров пробелами друг от друга

СОМНИТЕЛЬНЫЕ МЕСТА:
Все исправления, в которых ты не уверен на 100%, ОБЯЗАТЕЛЬНО укажи в секции "Сомнительные места" в конце текста. Формат:

---
Сомнительные места:
1. «исходное слово» → «исправленное слово» — краткое пояснение
2. ...

Если все исправления очевидны и сомнений нет, напиши:
---
Сомнительные места:
Нет сомнительных мест.

Пользователь сможет проверить каждое исправление и подтвердить или изменить его."""
    
    result = await db.prompts.update_one(
        {"prompt_type": "master"},
        {"$set": {"content": new_content, "updated_at": now}}
    )
    
    if result.matched_count == 0:
        return {"message": "Master prompt not found, run /seed first"}
    
    return {"message": "Master prompt updated successfully"}


@router.post("/seed")
async def seed_data():
    """Seed initial prompts and admin user"""
    now = datetime.now(timezone.utc).isoformat()
    
    # Check if master prompt exists
    existing = await db.prompts.find_one({"prompt_type": "master"})
    if existing:
        return {"message": "Data already seeded"}
    
    prompts = [
        {
            "id": str(uuid.uuid4()),
            "name": "Мастер промпт",
            "content": """Я буду представлять тебе тексты транскриптов встреч.

ИСПРАВЛЕНИЕ ОШИБОК:
Местами в них будут ошибки распознавания. Если заметишь такие ошибки (слова не соответствующие теме и контексту, искажённые имена, термины, аббревиатуры) — исправь их по контексту.
Суммаризировать высказывания спикеров нельзя, твоя задача — сохранять дословные транскрипты.

ОБЪЕДИНЕНИЕ РЕПЛИК:
В текстах транскрипта будут встречаться предложения, в середине которых происходит смена спикера (например — реплика следующего спикера начинается с маленькой буквы). В этом случае перенеси остальную часть фразы (до точки) в реплику предыдущего спикера.
Пример:
Speaker 1: ...Ты расскажи, ты общался там с кем-нибудь вообще? Слушай,
Speaker 2: если честно, пока ещё нет.

Надо делать так:
Speaker 1: ...Ты расскажи, ты общался там с кем-нибудь вообще?
Speaker 2: Слушай, если честно, пока ещё нет.

ЗАМЕНА СПИКЕРОВ:
Тебе также нужно будет делать замены авторов реплик в тексте — я буду их указывать перед началом текста транскрипта, например:
Speaker 0 — Дмитрий
Speaker 1 — Сабина

ФОРМАТИРОВАНИЕ:
- Сделай выделение имен спикеров болдом
- Отделяй реплики спикеров друг от друга пробелами
- Внутри реплики спикера пробелов между строчками не делай
- Разбивай длинные куски текста на смысловые абзацы для удобства чтения, но не отделяй эти абзацы внутри реплик спикеров пробелами друг от друга

СОМНИТЕЛЬНЫЕ МЕСТА:
Все исправления, в которых ты не уверен на 100%, ОБЯЗАТЕЛЬНО укажи в секции "Сомнительные места" в конце текста. Формат:

---
Сомнительные места:
1. «исходное слово» → «исправленное слово» — краткое пояснение
2. ...

Если все исправления очевидны и сомнений нет, напиши:
---
Сомнительные места:
Нет сомнительных мест.

Пользователь сможет проверить каждое исправление и подтвердить или изменить его.""",
            "prompt_type": "master",
            "user_id": None,
            "project_id": None,
            "is_public": True,
            "created_at": now,
            "updated_at": now
        },
        {
            "id": str(uuid.uuid4()),
            "name": "Протокол встречи",
            "content": "На основе транскрипта составь структурированный протокол встречи: 1. Участники, 2. Основные темы обсуждения, 3. Принятые решения, 4. Назначенные задачи с ответственными, 5. Следующие шаги",
            "prompt_type": "thematic",
            "user_id": None,
            "project_id": None,
            "is_public": True,
            "created_at": now,
            "updated_at": now
        },
        {
            "id": str(uuid.uuid4()),
            "name": "Ключевые решения",
            "content": "Выдели все ключевые решения, которые были приняты на встрече. Для каждого решения укажи: что решили, кто предложил, были ли возражения",
            "prompt_type": "thematic",
            "user_id": None,
            "project_id": None,
            "is_public": True,
            "created_at": now,
            "updated_at": now
        },
        {
            "id": str(uuid.uuid4()),
            "name": "Задачи и дедлайны",
            "content": "Составь список всех задач, упомянутых на встрече. Для каждой задачи укажи: описание, ответственный (если назначен), срок (если упоминался), приоритет (если обсуждался)",
            "prompt_type": "thematic",
            "user_id": None,
            "project_id": None,
            "is_public": True,
            "created_at": now,
            "updated_at": now
        }
    ]
    
    for prompt in prompts:
        await db.prompts.insert_one(prompt)
    
    # Create admin user if not exists
    admin = await db.users.find_one({"email": "admin@voiceworkspace.com"})
    if not admin:
        await db.users.insert_one({
            "id": str(uuid.uuid4()),
            "email": "admin@voiceworkspace.com",
            "password": hash_password("admin123"),
            "name": "Admin",
            "role": "admin",
            "created_at": now
        })
    
    return {"message": "Data seeded successfully"}
