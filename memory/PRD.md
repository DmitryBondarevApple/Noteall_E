# Voice Workspace — PRD

## Original Problem Statement
Приложение для транскрибации аудио/видео встреч с AI-обработкой и разметкой спикеров.

## Core Requirements
1. Автоматическая транскрибация (Deepgram)
2. AI-анализ встреч через OpenAI GPT
3. Разметка спикеров
4. Справочник спикеров
5. Конструктор сценариев анализа (визуальный, React Flow)
6. Пошаговое исполнение сценариев — **динамический визард на основе пайплайна**

## Architecture
- **Backend:** FastAPI + MongoDB + Pydantic
- **Frontend:** React + Tailwind + Shadcn/UI + React Flow (@xyflow/react)
- **AI:** OpenAI GPT (Emergent LLM Key)
- **Transcription:** Deepgram

## What's Been Implemented

### Транскрибация и спикеры
- [x] Загрузка и транскрибация аудио/видео
- [x] Разметка спикеров на вкладке Транскрипт
- [x] Справочник спикеров с парсингом "Имя (Компания)"
- [x] AI-обработка с подстановкой полных имён

### Конструктор сценариев анализа (Dec 2025)
- [x] CRUD API для пайплайнов
- [x] Визуальный редактор на React Flow
- [x] 7 типов узлов: ai_prompt, parse_list, batch_loop, aggregate, template, user_edit_list, user_review
- [x] Два типа стрелок: порядок выполнения (серые) и источники данных (оранжевые пунктирные)
- [x] Хэндлы на всех 4 сторонах блоков, скрыты при отсутствии наведения
- [x] Ортогональная маршрутизация стрелок (smoothstep)
- [x] Undo/Redo + горячие клавиши
- [x] Скрипты для всех типов узлов-обработчиков
- [x] AI-помощник для генерации скриптов
- [x] Режим "Предпросмотр" — пошаговый визард из конструктора
- [x] Дефолтный пайплайн "Стандартный анализ встречи"

### Динамический визард Мастер-анализа (Feb 2025)
- [x] Движок исполнения пайплайна — `FullAnalysisTab.jsx` полностью рефакторён
- [x] Настройки визарда в конструкторе (секция "Настройки визарда" в NodeConfigPanel):
  - step_title (макс. 40 символов) + счётчик
  - step_description (макс. 200 символов) + счётчик
  - continue_button_label (макс. 25 символов) + счётчик
  - pause_after (для автоматических узлов)
- [x] Настройки template-узлов: variable_config (подпись, подсказка, тип поля, обязательность)
- [x] Настройки user_edit_list: allow_add, allow_edit, allow_delete, min_selected
- [x] Настройки user_review: allow_review_edit, show_export, show_save
- [x] Топологическая сортировка + группировка узлов в стадии визарда
- [x] Автоматическое выполнение AI-узлов и скриптов
- [x] Батч-обработка с прогресс-баром и паузой
- [x] Контекст выполнения — передача данных между узлами
- [x] Дефолтный пайплайн обновлён с настройками визарда

### Сохранение результата визарда (Feb 2025)
- [x] `forceMount` на TabsContent — результат визарда сохраняется при переключении вкладок
- [x] Кнопка "Новый анализ" с AlertDialog подтверждения (предупреждение о потере результата)
- [x] Текст предупреждения с рекомендацией сохранить/экспортировать перед сбросом

### Вкладка "Результаты" (Feb 2025)
- [x] Вкладка "Анализ" → "Результаты", перемещена в конец таб-меню (после "Мастер")
- [x] Список сохранённых результатов мастер-анализа с карточками
- [x] Мультивыбор чекбоксами + "Выбрать все"
- [x] Просмотр результата: Markdown-рендер, редактирование, экспорт (Copy, .md, Word, PDF)
- [x] Удаление результата с AlertDialog подтверждением
- [x] Панель действий при выборе: "Анализ по промпту" (re-analysis выбранных результатов)
- [x] Бэкенд: GET /api/projects/:id/analysis-results, DELETE /api/projects/:id/chat-history/:id
- [x] Метаданные pipeline_id/pipeline_name в сохранённых результатах

## Key Files
- `frontend/src/components/project/FullAnalysisTab.jsx` — динамический визард
- `frontend/src/components/pipeline/NodeConfigPanel.jsx` — панель конфигурации с настройками визарда
- `frontend/src/components/pipeline/PipelineStepPreview.jsx` — предпросмотр
- `backend/app/models/pipeline.py` — модель PipelineNodeConfig с полями визарда
- `backend/app/routes/pipelines.py` — API пайплайнов

## Prioritized Backlog

### P0
- [ ] Полное end-to-end тестирование с реальным транскриптом (загрузка аудио → анализ через динамический визард)

### P1
- [ ] Интеграция с библиотекой промптов (prompt_id в узлах)
- [ ] Создание промптов из конструктора

### P2
- [ ] condition (ветвление)
- [ ] extract_json
- [ ] merge (параллельные ветки)
