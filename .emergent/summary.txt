<analysis>**original_problem_statement:** The user's primary goal is to build a sophisticated web application for transcribing and analyzing audio files. The latest major feature request is to automate a complex, multi-step analysis workflow.

**PRODUCT REQUIREMENTS:**
The user has defined a detailed workflow for a new feature called **Мастер полного анализа встречи (Full Analysis Wizard)**:
1.  **Start:** The user provides the key subject of discussion for a transcript.
2.  **Extract Topics:** An AI prompt generates a list of discussed topics from the transcript. The user must be able to review and edit this list.
3.  **Detailed Analysis:** The AI generates a detailed summary for each topic. This process runs in batches (e.g., 3 topics at a time), with the batch size being configurable by the user.
4.  **Combine:** All the detailed topic summaries are scripted together into a single large document.
5.  **Final Summary:** The AI generates a final, short summary (including agreements and action items) based on the combined document from the previous step.
6.  **Final Document:** The output is presented in a new tab, with the short summary at the top, followed by the detailed topic-by-topic analysis. The entire result is saved as a single analysis entry.

Additionally, the user previously requested and received features for a global speaker directory, autosaving drafts, and the ability to undo confirmed corrections.

**User's preferred language**: The user communicates in **Russian**. The next agent MUST respond in Russian.

**what currently exists?**
The application consists of a React frontend and a modular FastAPI backend using MongoDB. It supports audio transcription (Deepgram), AI-powered text processing (GPT-4o), and analysis.

Key features implemented:
-   **Core:** Asynchronous processing of long AI tasks with frontend polling.
-   **Frontend Refactoring:** The main  has been successfully refactored into smaller, logical components located in .
-   **Backend Refactoring:** The monolithic  has been completely modularized into a standard FastAPI structure (, , , ).
-   **Speaker Directory:** A global, editable directory for speakers with CRUD functionality and an autocomplete combobox for easy assignment in projects. Speaker profiles include fields for photo, contact details, and comments. The directory page allows grouping speakers by company.
-   **UX Improvements:** Autosave for drafts in edit-mode and the ability to revert a confirmed correction in the Review tab.
-   **Prompt Engineering:** The master prompt for text processing has been iteratively refined based on detailed user feedback to ensure it corrects text while also flagging uncertain words for review.

**Last working item**:
-   **Last item agent was working:** The agent began implementing the **Мастер полного анализа встречи (Full Analysis Wizard)** feature. The initial scaffolding is in place:
    1.  A new frontend component was created: .
    2.  A new backend endpoint was added:  in . This endpoint performs a raw AI call without saving the result to the chat history, intended for use in the intermediate steps of the wizard.
-   **Status:** IN PROGRESS
-   **Agent Testing Done:** N
-   **Which testing method agent to use?** frontend testing agent. This is a complex multi-step UI wizard that will require thorough testing of the entire flow once the implementation is complete.
-   **User Testing Done:** N

**All Pending/In progress Issue list**:
There are no outstanding bugs. The focus is on completing the new feature.

**In progress Task List**:
-   **Task 1: Implement the Мастер полного анализа встречи (Full Analysis Wizard) (P0)**
    -   **Where to resume:** The basic component  and the helper backend endpoint  are created. The next step is to build out the full wizard logic inside .
        -   **UI/State:** Implement the multi-step UI (Step 1: Setup, Step 2: Topic Review, Step 3: Progress, Step 4: Final Document) and manage the state transitions.
        -   **API Calls:** Use the  endpoint to get the topic list and the summary for each batch of topics.
        -   **Logic:** Implement the logic to allow topic editing, configurable batch processing, and scripting the final document together.
        -   **Save:** Use the existing  endpoint to save the final generated document.
        -   **Integration:** Add the  to the tabbed interface in .
    -   **What will be achieved with this?** It will deliver a key user-requested feature, automating a complex and time-consuming analysis workflow.
    -   **Status:** IN PROGRESS
    -   **Should Test frontend/backend/both after fix?** Both
    -   **Blocked on something:** None

**Upcoming and Future Tasks**
-   **Tags for Speaker Directory (P1):** Add a tagging system to the speaker directory to allow for better filtering and organization.
-   **Import/Export (P2):**
    -   Implement a feature to import speakers from a CSV file.
    -   Implement a feature to export transcripts.

**Completed work in this session**
-   **Bug Fix:** Confirmed the fix for speaker names not appearing correctly in the Review tab.
-   **Major Backend Refactoring:** Successfully modularized the entire  file into a structured application under .
-   **Major Frontend Refactoring:** Decomposed the large  into smaller, reusable components.
-   **Feature: Speaker Directory:** Implemented a full-featured global speaker directory with a management UI, CRUD APIs, autocomplete search, and extended profile fields (photo, contacts).
-   **Feature: Group Speakers by Company:** Added a view toggle on the speaker directory page to group speakers by their company.
-   **Feature: Autosave Drafts:** Implemented -based autosaving for text being edited.
-   **Feature: Undo Confirmation:** Added the ability to revert a confirmed word correction in the Review tab.
-   **Prompt Engineering:** Iteratively updated the master prompt based on detailed user feedback to achieve the desired AI behavior.

**Earlier issues found/mentioned but not fixed**
-   None. All previously mentioned issues have been addressed.

**Known issue recurrence from previous fork**
-   Not applicable.

**Code Architecture**


**Key Technical Concepts**
-   **Frontend:** React, Tailwind CSS, Shadcn/UI.
-   **Backend:** FastAPI (modular architecture), Python, Motor (async MongoDB driver).
-   **Database:** MongoDB.
-   **AI/LLM:** Deepgram (transcription), OpenAI GPT-4o (text processing/analysis).
-   **Architecture:** Asynchronous backend with background tasks and frontend polling. A complex multi-step wizard pattern is being implemented on the frontend.

**key DB schema**
-   **projects:** Stores project metadata, transcripts, and analysis results.
-   **chat_history:** Stores conversation history for the analysis tab.
-   **speaker_directory:** (New) Stores global speaker profiles.
    -   uid=0(root) gid=0(root) groups=0(root): (string, uuid)
    -   : (string)
    -   : (string, optional)
    -   : (string, optional)
    -   : (string, optional)
    -   : (string, optional)
    -   : (string, optional)
    -   : (string, optional)

**changes in tech stack**
-   None.

**All files of reference**
-   **New Feature Files:**
    -   : (In Progress) The main component for the new Analysis Wizard.
    -   : Modified to add the  endpoint.
-   **Refactoring & Speaker Directory Files (Completed):**
    -   All files under  (core, models, routes, services, main.py).
    -   All new components under .
    -   
    -   

**Areas that need refactoring**:
-   None. The agent has proactively refactored both the frontend () and backend (), addressing the major sources of technical debt.

**key api endpoints**
-   **Speaker Directory:**
    -   : List all or create a new speaker.
    -   : Update or delete a speaker.
    -   : Upload a photo for a speaker.
-   **Analysis Wizard Helper:**
    -   : Perform a raw AI query without saving it to the history.
-   **Fragments:**
    -   : Revert a confirmed fragment back to pending.

**Critical Info for New Agent**
-   **Backend Refactoring:** The backend logic is no longer in . It has been completely moved to a modular structure inside the  directory. Refer to the new file structure for any backend changes.
-   **Analysis Wizard:** The new Full Analysis Wizard feature requires using the special  endpoint for all intermediate steps (like fetching topics or summarizing batches) to avoid cluttering the main analysis chat history. The final combined result should be saved using the standard analysis endpoint.

**documents and test reports created in this job**
-    (updated multiple times).

**Last 10 User Messages and any pending HUMAN messages**
1.  **User (Chat 338):** Provided a detailed, 5-step workflow for a Full Analysis feature.
    -   *Status: IN PROGRESS. This is the current main task.*
2.  **Agent (Chat 339):** Proposed a plan to implement the workflow as a multi-step wizard.
    -   *Status: PLAN PROPOSED.*
3.  **User (Chat 340):** Approved the wizard plan with specific clarifications: use intermediate stops, allow user to set batch size for topics, allow topic editing, show results in a new tab, and save as one final result.
    -   *Status: REQUIREMENTS FINALIZED. Implementation started.*
4.  **Agent (Chat 341-346):** Started implementation by creating the frontend component  and the backend endpoint .
    -   *Status: IN PROGRESS. This is where the last session left off.*

**Project Health Check:**
-   **Broken:** None
-   **Mocked:** None

**3rd Party Integrations**
-   **Deepgram:** Used for audio-to-text transcription. Requires a User API Key.
-   **OpenAI GPT-4o:** Used for all AI-based text processing and analysis. Uses the Emergent LLM Key.

**Testing status**
-   **Testing agent used after significant changes:** NO
-   **Troubleshoot agent used after agent stuck in loop:** NO
-   **Test files created:** None.
-   **Known regressions:** None.

**Credentials to test flow:**
-   No specific user credentials are required.

**What agent forgot to execute**
-   The agent was in the middle of implementing the Full Analysis Wizard feature. The work is not forgotten, just incomplete, and is the highest priority for the next session.</analysis>
