<?xml version="1.0" encoding="utf-8"?><testsuites name="pytest tests"><testsuite name="pytest" errors="0" failures="1" skipped="0" tests="4" time="6.615" timestamp="2026-02-11T17:58:47.239492+00:00" hostname="agent-env-02631a3a-2bba-4562-ad6d-95b6cc775957"><testcase classname="backend.tests.test_ai_chat_input_from.TestAiChatSystemPrompt" name="test_system_prompt_contains_input_from_rules" time="0.001"><failure message="AssertionError: Should show example of input_from array&#10;assert 'input_from: [&quot;step_1&quot;]' in 'import uuid\nimport base64\nimport json\nimport logging\nfrom datetime import datetime, timezone\nfrom typing import Optional\nfrom fastapi import APIRouter, HTTPException, Depends, UploadFile, File, Form\nfrom pydantic import BaseModel\nfrom app.core.database import db\nfrom app.core.security import get_current_user\nfrom app.services.gpt import call_gpt_chat, call_gpt_chat_metered\nfrom app.services.metering import check_user_monthly_limit, check_org_balance, deduct_credits_and_record\nfrom app.services.s3 import s3_enabled, upload_bytes, presigned_url, download_bytes\nfrom app.models.ai_chat import AiChatSessionResponse, AiChatSessionListItem, AiChatMessage\n\nrouter = APIRouter(prefix=&quot;/ai-chat&quot;, tags=[&quot;ai-chat&quot;])\nlogger = logging.getLogger(__name__)\n\nSYSTEM_PROMPT = &quot;&quot;&quot;Ты — AI-ассистент платформы Noteall. Твоя задача — помогать пользователю создавать и редактировать сценарии анализа документов и транскриптов встреч.\n\nСценарий — это граф из узлов (nodes) и связей (edges). Каждый узел имеет тип и конфигурацию.\n\nДОСТУПНЫЕ ТИПЫ УЗЛОВ:\n1. &quot;ai_prompt&quot; — AI-промпт. Отправляет текст в GPT для анализа. Параметры: inline_prompt (текст промпта), system_message (системное сообщ...    &quot;usage&quot;: metering_info,\n    }\n\n\ndef _extract_pipeline_json(text: str) -&gt; Optional[dict]:\n    &quot;&quot;&quot;Try to extract pipeline JSON from AI response text.&quot;&quot;&quot;\n    try:\n        # Look for ```json ... ``` blocks\n        if &quot;```json&quot; in text:\n            start = text.index(&quot;```json&quot;) + 7\n            end = text.index(&quot;```&quot;, start)\n            json_str = text[start:end].strip()\n            data = json.loads(json_str)\n            if isinstance(data, dict) and &quot;nodes&quot; in data:\n                return data\n        elif &quot;```&quot; in text:\n            start = text.index(&quot;```&quot;) + 3\n            # Skip optional language marker on same line\n            newline = text.index(&quot;\\n&quot;, start)\n            start = newline + 1\n            end = text.index(&quot;```&quot;, start)\n            json_str = text[start:end].strip()\n            data = json.loads(json_str)\n            if isinstance(data, dict) and &quot;nodes&quot; in data:\n                return data\n        # Try parsing the whole response as JSON\n        data = json.loads(text.strip())\n        if isinstance(data, dict) and &quot;nodes&quot; in data:\n            return data\n    except (ValueError, json.JSONDecodeError):\n        pass\n    return None\n'">backend/tests/test_ai_chat_input_from.py:59: in test_system_prompt_contains_input_from_rules
    assert "input_from: [\"step_1\"]" in content, "Should show example of input_from array"
E   AssertionError: Should show example of input_from array
E   assert 'input_from: ["step_1"]' in 'import uuid\nimport base64\nimport json\nimport logging\nfrom datetime import datetime, timezone\nfrom typing import Optional\nfrom fastapi import APIRouter, HTTPException, Depends, UploadFile, File, Form\nfrom pydantic import BaseModel\nfrom app.core.database import db\nfrom app.core.security import get_current_user\nfrom app.services.gpt import call_gpt_chat, call_gpt_chat_metered\nfrom app.services.metering import check_user_monthly_limit, check_org_balance, deduct_credits_and_record\nfrom app.services.s3 import s3_enabled, upload_bytes, presigned_url, download_bytes\nfrom app.models.ai_chat import AiChatSessionResponse, AiChatSessionListItem, AiChatMessage\n\nrouter = APIRouter(prefix="/ai-chat", tags=["ai-chat"])\nlogger = logging.getLogger(__name__)\n\nSYSTEM_PROMPT = """Ты — AI-ассистент платформы Noteall. Твоя задача — помогать пользователю создавать и редактировать сценарии анализа документов и транскриптов встреч.\n\nСценарий — это граф из узлов (nodes) и связей (edges). Каждый узел имеет тип и конфигурацию.\n\nДОСТУПНЫЕ ТИПЫ УЗЛОВ:\n1. "ai_prompt" — AI-промпт. Отправляет текст в GPT для анализа. Параметры: inline_prompt (текст промпта), system_message (системное сообщ...    "usage": metering_info,\n    }\n\n\ndef _extract_pipeline_json(text: str) -&gt; Optional[dict]:\n    """Try to extract pipeline JSON from AI response text."""\n    try:\n        # Look for ```json ... ``` blocks\n        if "```json" in text:\n            start = text.index("```json") + 7\n            end = text.index("```", start)\n            json_str = text[start:end].strip()\n            data = json.loads(json_str)\n            if isinstance(data, dict) and "nodes" in data:\n                return data\n        elif "```" in text:\n            start = text.index("```") + 3\n            # Skip optional language marker on same line\n            newline = text.index("\\n", start)\n            start = newline + 1\n            end = text.index("```", start)\n            json_str = text[start:end].strip()\n            data = json.loads(json_str)\n            if isinstance(data, dict) and "nodes" in data:\n                return data\n        # Try parsing the whole response as JSON\n        data = json.loads(text.strip())\n        if isinstance(data, dict) and "nodes" in data:\n            return data\n    except (ValueError, json.JSONDecodeError):\n        pass\n    return None\n'</failure></testcase><testcase classname="backend.tests.test_ai_chat_input_from.TestImportPipelineInputFromFix" name="test_import_pipeline_auto_fixes_input_from" time="0.423" /><testcase classname="backend.tests.test_ai_chat_input_from.TestAiChatMessageEndpoint" name="test_create_and_send_message" time="6.045" /><testcase classname="backend.tests.test_ai_chat_input_from.TestPipelineEdgesConsistency" name="test_create_pipeline_with_edges" time="0.086" /></testsuite></testsuites>